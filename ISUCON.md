## 1.ISUCONの目標

TOPページ(SP)において、on load時間を短縮する

測定方法としては、/test.phpにアクセスし、[測定]ボタンをクリックする。
このボタンをクリックすると、現在時間をクエリ文字列に載せて、TOPページをリクエストする。
TOPページのHTMLに記載のJavaScriptがon load時の時間と先程の現在時間との差をブラウザのconsoleに出力する。それをon load時間としている。

なお、この測定を5回繰り返し、一番速い結果をチームの記録とする。

## 2.on loadとは

on loadとはリクエストしてからHTMLデータやそれに記載されているCSS/JavaScript/Font/Image(以下、静的ファイル)などの**ファイルを読み込むのにかかった時間**  
飽くまでファイルを読み込んだ時間なので、JS内の処理が重かったり、XHRの応答が遅くてもon loadの時間には関係ない。


そのため、現時点での論点としては、①いかに速くHTMLを返すか、②HTMLに記載されている静的ファイルをいかに速く返すかの2点といえます。

## 3.高速化としてのキャッシュ

キャッシュとは、データを取得する際に、一時保存しておき、再度取得する際は、その保存したデータを使用することです。

高速化を考える際、キャッシュが可能であれば、まずそれを考えるべきといえます。

ブラウザからリクエストが来て、その後PHPのファイルを実行する際、まずPHPファイルをコンパイルし、バイトコードに変換し、CPUが処理可能な形式に変換します。それからプログラムを処理したり、データの取得・生成をしたりして、最終的にブラウザにレスポンスを返します。

PHPの場合、キャッシュの方法としては、バイトコードをキャッシュし、リクエスト毎にコンパイルをさせない方法と、データのキャッシュの方法の2つがあります。

### 3-1.コードのキャッシュ

OPCache はコンパイル済みのバイトコードを共有メモリに保存し、PHP がリクエストのたびにスクリプトを読み込み、パースする手間を省くことでパフォーマンスを向上させます。
(https://www.php.net/manual/ja/intro.opcache.php)

### 3-2.データのキャッシュ

まずデータのキャッシュの話をする前に、ブラウザからのリクエストしてからレスポンスのデータをブラウザで表示するまでの過程をみてみます。

1. ブラウザでGETリクエスト
2. Apacheでリクエスト処理
3. FPMでリクエストを処理
4. バイトコードを実行(データ処理やDBアクセス)し、レスポンスデータ(HTML)作成
6. FPMにレスポンス
7. Apacheにレスポンス
8. ブラウザにレスポンス
9. HTMLをパースし、描画(同時に静的ファイルをリクエスト※静的ファイルの場合は、Apacheのみでレスポンス)

キャッシュするポイントとしては、下記です。
#### 3-2-1.ブラウザ
ブラウザキャッシュ(メモリ・ディスク)
ストレージ(Cookie,LocalStorageなど)

#### 3-2-2.Apache
静的ファイルのキャッシュ

#### 3-2-3.サーバ(Web)
- メモリ(共有メモリ)
- ファイル
- SQLite

#### 3-2-4.DB
- DB(クエリキャッシュ)

#### 3-2-5.その他
- Redis

### 3-3. キャッシュの対象と保持期間と削除

|カテゴリ|方法|対象|保持期間|削除トリガー|備考|
|---|---|---|---|---|---|
|ブラウザ|ブラウザキャッシュ|静的ファイル|制限なしでok|-|-|
|ブラウザ|ストレージ|データ|-|-|キャッシュ削除のことを考えると実装が面倒そうだから無いかな。あと個人情報についてはXSSの問題でキャッシュできない。|
|Apache|静的ファイルキャッシュ|静的ファイル|制限なしでok|-|静的ファイルについてはブラウザキャッシュすれば良い|
|サーバ(web)|メモリ(共有)|データ|-|-|別途説明|
|サーバ(web)|ファイル|データ|-|-|別途説明|
|サーバ(web)|SQLite|データ|-|-|別途説明|
|DB|クエリキャッシュ|データ|??|??|-|
|その他|Redis|データ|-|-|別途説明|

### 3-4. キャッシュ可能の条件

静的ファイルはその名のとおり、静的なファイルなのでどのような条件(時・場所・ユーザなど)でも同じファイルであるため、
ブラウザでキャッシュして問題ない。

しかし、HTMLデータなどの動的なデータについてはそうではない。  
ユーザによって異なる場合は、セッションを扱うことのできるPHP内でのキャッシュが必要となる。

さらに、副作用(実行毎に処理の結果が変わる可能性があるもの)が伴う処理の場合は、より考慮が必要である。

副作用の例としては、状態を持つデータと時間が関わる処理とランダムな処理の3つある。

#### 3-4-1. 状態

advertisementテーブルの状態やadvertisement_frameテーブルの状態によって処理が変わる。

```sql
select ad_id, ad_name, affiliate_link from advertisement
inner join advertisement_frame on advertise.ad_id = advertisement_frame.ad_id
```

ただ、advertisementテーブルやadvertisement_frameテーブルを更新するのは管理画面で行われるはずなので、
その際にキャッシュを削除すれば良い。

#### 3-4-2. 時間
時間によって、select文の結果が異なるので、キャッシュすると意図しないデータを表示させてしまう。
```sql
select ad_id, ad_name, affiliate_link from advertisement where start_date >= now() and end_date >= now()
```
10秒などの時間であれば、キャッシュして良いかもしれない。(吉本さん・高崎に確認)

#### 3-4-3. ランダム
(省略)
10秒などの時間であれば、キャッシュして良いかもしれない。(吉本さん・高崎に確認)


## 4. 分担

### 4-1. アプリケーション内でのキャッシュ
- キャッシュ場所の選定(キャッシュ場所とキャッシュ方法を別軸で考えたい。)
- アプリケーション内でのキャッシュ方法の調査
- アプリケーション内でのキャッシュ方法の最適化

### 4-2. ブラウザキャッシュ
https://qiita.com/hkusu/items/468cc0ee0d767e7cc790

### 4-3. コードのキャッシュ

slackのsystem部屋で菊地さんが言ってた。


### 4-4. その他チューニング(キャッシュが使えない場合)

- 冗長な処理削除(DBのアクセス回数を減らすなど)
- クエリチューニング(indexつけるとか。explain見て頑張る)
- 不要処理削除
